<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <Title>Namsor</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/logo/favicon.png">

    <!-- plugins css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/PACE/themes/blue/pace-theme-minimal.css" />
    <link rel="stylesheet" href="bower_components/perfect-scrollbar/css/perfect-scrollbar.min.css" />
    <!-- core css -->
    <link href="assets/css/ei-icon.css" rel="stylesheet">
    <link href="assets/css/themify-icons.css" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/animate.min.css" rel="stylesheet">
    <link href="assets/css/app.css" rel="stylesheet">
    <link href="assets/css/own.css" rel="stylesheet">
</head>

<body>
    <div class="app side-nav-dark">
        <div class="layout">
          <!-- Side Nav START -->
          <div class="side-nav">
            <div class="side-nav-inner">
              <div class="side-nav-logo">
                <a href="index.html">
                  <div class="logo logo-dark" style="background-image: url('assets/images/logo/logo.png')"></div>
                  <div class="logo logo-white" style="background-image: url('assets/images/logo/logo.png')"></div>

                </a>
                <div class="mobile-toggle side-nav-toggle">
                  <a href="">
                    <i class="ti-arrow-circle-left"></i>
                  </a>
                </div>
              </div>
              <ul class="side-nav-menu scrollable">
                <li class="nav-item">
                  <a class="mrg-top-30" href="index.html">
                    <span class="icon-holder">
                      <i class="ti-home"></i>
                    </span>
                    <span class="title">Home</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="mrg-top-30" href="services.html">
                    <span class="icon-holder">
                      <i class="ei-hand"></i>
                    </span>
                    <span class="title">Services</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="mrg-top-30" href="apidoc.html">
                    <span class="icon-holder">
                      <i class="ei-file-code"></i>
                    </span>
                    <span class="title">API Documentation</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="mrg-top-30" href="contact.html">
                    <span class="icon-holder">
                      <i class="ei-phone-book-contact"></i>
                    </span>
                    <span class="title">Contact</span>
                  </a>
                </li>

              </ul>
            </div>
          </div>
          <!-- Side Nav END -->

            <!-- Page Container START -->
            <div class="page-container">
              <!-- Header START -->
              <div class="header navbar">
                <div class="header-container">
                  <ul class="nav-left">
                    <li>
                      <a class="side-nav-toggle" href="javascript:void(0);">
                        <i class="ti-view-grid"></i>
                      </a>
                    </li>
                  </ul>
                  <ul class="nav nav-right" id="boxSign">
                    <li class="nav-item">
                      <button id="signin" class="nav-link btn btn-outline-success" type="submit" onclick="location.href='sign-in.html'">Sign in</button>

                    </li>
                  </ul>
                </div>
              </div>
              <!-- Header END -->

                <!-- Content Wrapper START -->
                <div class="main-content">
                  <div class="container-fluid">
                    <div class="page-title">
                      <h4>Invoices</h4>
                    </div>
                    <div class="row">
                      <div class="col-md-12">
                        <div class="card">
                          <div class="card-heading border bottom">
                            <h4 class="card-title">Summary</h4>
                          </div>
                          <div class="card-block" id="invoicesContent">
                            
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Content Wrapper END -->
                <!-- Footer START -->
                <footer class="content-footer">
                  <div class="footer">
                    <div class="copyright">
                      <span>Copyright Â© 2018 <b class="text-dark">Namsor</b>. All rights reserved.</span>
                      <span class="go-right">
                        <a href="" class="text-gray mrg-right-15">Term &amp; Conditions</a>
                        <a href="" class="text-gray">Privacy &amp; Policy</a>
                      </span>
                    </div>
                  </div>
                </footer>
                <!-- Footer END -->


            </div>
            <!-- Page Container END -->

        </div>
    </div>

    <!-- build:js assets/js/vendor.js -->
    <!-- plugins js -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/chart.js/dist/Chart.min.js"></script>
    <script src="bower_components/popper.js/dist/umd/popper.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/PACE/pace.min.js"></script>
    <script src="bower_components/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
    <!-- endbuild -->

    <!-- build:js assets/js/app.min.js -->
    <!-- core js -->
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase.js"></script>
    <script src="assets/js/firebase.js" charset="utf-8"></script>
    <script>
      
      const invoicesContent = document.getElementById('invoicesContent');
      
      let insertInfos = function(datas) {
        let invoiceInfo = document.getElementById('invoiceInfo');
        let innerDoc;
        if (invoiceInfo)
          innerDoc = invoiceInfo.contentDocument || invoiceInfo.contentWindow.document;
        else
        {
          console.log('error');
          return('');
        }
        billingInfo().then(function(address){
          infos = JSON.parse(address);
          let items = datas.items;
          let fill = (x, y) => {
            if (innerDoc.getElementById(x) !== null && y[x] !== null) 
              innerDoc.getElementById(x).innerHTML = y[x];
          }
          for (info in infos)
              fill(info, infos);
          for (data in datas)
            fill(data, datas);
          for (item in items)
          {
            console.log(item);
            let tr = document.createElement('tr');
            tr.innerHTML = `<th>${item.id}</th>
            <th>${item.subscription}</th>
            <th>${item.quantity}</th>
            <th>${item.amount}</th>
            <th class="text-right"></th>`;
            innerDoc.getElementById("invoiceSoloContent").prepend(tr);
          }
        })
        .catch(error => {
          console.log(error);
        });
      }

      let insertInvoice = function(data){
        let invoice = document.createElement('iframe');
        invoice.width = "100%";
        invoice.height = "800px";
        invoice.src = "invoice.html";
        invoice.id = "invoiceInfo"
        $('table').slideUp('slow', () => {
          $('#invoicesContent').prepend(invoice);
          $('iframe').ready(insertInfos(data));
          insertBack();
        });
      };

      let insertBack = function () {
        let btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.innerHTML = '<i class="ti-angle-left font-size-10"></i>';
        btn.id = 'back'
        btn.addEventListener('click', function() {
          $('#back').remove();
          $('iframe').remove();
          $('table').slideDown('slow');
        });
        invoicesContent.prepend(btn);
      };

      let insertData = function(){
        initApp().then(billingHistory().then(
          data => {
            data = JSON.parse(data);
            console.log(data);
            invoicesContent.innerHTML =
            `
            <table class="table table-hover" id ='invoicesTable'>              
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Date</th>
                  <th scope="col">Subscription</th>
                  <th scope="col">Price</th>
                  <th scope="col">Details</th>
                  </tr>
              </thead>
              <tbody>
              </tbody>
            </table>`;
            invoices = data.stripeInvoices.concat(data.corporateInvoices);
            invoices.sort((a, b) => a['invoiceDate'] - b['invoiceDate']);
            invoices.forEach((invoice, index) => {
              let tr = document.createElement('tr');
              let date = new Date(parseInt(invoice['invoiceDate'])).toDateString();
              let name = 'temporary name';
              let html =
              '<td>' + index + '</td>' +
              '<td>' + date + '</td>' +
              '<td>' + name + '</td>' +
              '<td>' + invoice['amountPaid'] + '</td>';
              tr.innerHTML = html;
              let link = document.createElement('td');
              if (invoice.isStriped) {
                link.innerHTML = '<a target="blank" href="' + invoice['invoicePdf'] + '">Download here</a>'
              }
              else {
                let btton = document.createElement('button');
                btton.innerHTML = "View Details";
                btton.className = 'btn-link border-0 p-0';
                btton.addEventListener('click', function(){
                  insertInvoice(invoice);
                });
                link.appendChild(btton);
              }
              tr.appendChild(link);
              document.getElementById('invoicesTable').prepend(tr);
            });
          }
        ));
      };
        
      window.onload = function (){
        invoicesContent.innerHTML =
          `<div class="artboard">
            <div class="domino">
              <div></div>
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>`;
        insertData();
      }
                  </script>
    <script src="assets/js/app.js"></script>
    <!-- endbuild -->

    <!-- page js -->

</body>

</html>
